name: CI

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  pull_request:
    branches: [ main ]

env:
  RUST_BACKTRACE: 1

jobs:
  linux-checks:
    name: Linux / fmt + clippy + tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Linux build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang pkg-config libgtk-3-dev
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo
          restore-keys: ${{ runner.os }}-cargo-
      - name: Cargo fmt
        run: cargo fmt --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Cargo test (all targets, all features)
        run: cargo test --all-targets --all-features -- --nocapture

  macos-checks:
    name: macOS / fmt + clippy + tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install macOS build deps
        run: brew install gtk+3
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo
          restore-keys: ${{ runner.os }}-cargo-
      - name: Cargo fmt
        run: cargo fmt --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Cargo test (all targets, all features)
        run: cargo test --all-targets --all-features -- --nocapture

  windows-tests:
    name: Windows / fmt + clippy + tests
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo
          restore-keys: ${{ runner.os }}-cargo-
      - name: Cargo fmt
        run: cargo fmt --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Cargo test (all targets, all features)
        run: cargo test --all-targets --all-features -- --nocapture

  windows-msi:
    name: Windows / MSI packaging (tags)
    runs-on: windows-latest
    needs: [windows-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Build release binary
        run: cargo build --release
      - name: Install WiX Toolset
        run: |
          choco install wixtoolset --version 3.14.0 -y
          "WIX=$((Get-Item 'C:/Program Files (x86)/WiX Toolset v3.14/bin').FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Install cargo-wix
        run: cargo install cargo-wix --locked
      - name: Build unsigned MSI (ui crate)
        run: |
          cd ultrasearch/crates/ui
          cargo wix -p ui
      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultrasearch-msi
          path: ultrasearch/crates/ui/target/wix/*.msi
      - name: Upload release binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultrasearch-release-bin
          path: ultrasearch/target/release/ui.exe

  windows-e2e-smoke:
    name: Windows / E2E smoke (service + CLI)
    runs-on: windows-latest
    needs: [linux-checks, macos-checks, windows-tests]
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Build release
        run: cargo build --release
      - name: CLI help smoke
        run: cargo run -p cli -- --help
      - name: Start service in background
        run: |
          $svc = Start-Process -FilePath "ultrasearch/target/release/service.exe" -ArgumentList "--console" -WindowStyle Hidden -PassThru
          $svc.Id | Out-File service.pid
      - name: Wait for IPC and run status
        run: |
          Start-Sleep -Seconds 3
          $pid = Get-Content service.pid
          $null = cargo run -p cli -- status --json
          Stop-Process -Id $pid
      - name: UI build presence
        run: Test-Path ultrasearch/target/release/ui.exe | Out-Null

  release-publish:
    name: Publish release artifacts
    runs-on: ubuntu-latest
    needs: [windows-msi]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          name: ultrasearch-msi
          path: dist
      - name: Download release binary
        uses: actions/download-artifact@v4
        with:
          name: ultrasearch-release-bin
          path: dist
      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.msi
            dist/ui.exe
