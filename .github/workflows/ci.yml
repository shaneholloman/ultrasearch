name: CI

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  pull_request:
    branches: [ main ]

env:
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  windows-tests:
    name: Windows / fmt + clippy + tests
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      CARGO_TARGET_DIR: target
      CARGO_INCREMENTAL: 0
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - name: Install GraalVM CE 23 (zip) and set JAVA_HOME/GRAALVM_HOME
        run: |
          $ErrorActionPreference = "Stop"
          $uri = "https://download.oracle.com/graalvm/23/latest/graalvm-jdk-23_windows-x64_bin.zip"
          $zip = "$env:TEMP\graalvm.zip"
          Invoke-WebRequest -Uri $uri -OutFile $zip
          $dest = "C:\Program Files\GraalVM"
          if (-Not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }
          Expand-Archive -Force -Path $zip -DestinationPath $dest
          $graal = Get-ChildItem $dest | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $graal) { throw "GraalVM not found after unzip" }
          $env:GRAALVM_HOME = $graal.FullName
          $env:JAVA_HOME = $env:GRAALVM_HOME
          "GRAALVM_HOME=$env:GRAALVM_HOME" >> $env:GITHUB_ENV
          "JAVA_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
          # Append GraalVM bin to PATH (note: GITHUB_PATH expects bare paths, not `PATH=...`)
          "$env:GRAALVM_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo
          restore-keys: ${{ runner.os }}-cargo-
      - name: Cargo fmt
        run: cargo fmt --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Cargo test (all targets, all features)
        run: cargo test --all-targets --all-features -- --nocapture

  windows-msi:
    name: Windows / MSI packaging (tags)
    runs-on: windows-latest
    needs: [windows-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      msi_built: ${{ steps.set_msi_output.outputs.msi_built }}
    timeout-minutes: 60
    env:
      CARGO_TARGET_DIR: target
      CARGO_INCREMENTAL: 0
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - name: Install GraalVM CE 23 (zip) and set JAVA_HOME/GRAALVM_HOME
        run: |
          $ErrorActionPreference = "Stop"
          $uri = "https://download.oracle.com/graalvm/23/latest/graalvm-jdk-23_windows-x64_bin.zip"
          $zip = "$env:TEMP\graalvm.zip"
          Invoke-WebRequest -Uri $uri -OutFile $zip
          $dest = "C:\Program Files\GraalVM"
          if (-Not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }
          Expand-Archive -Force -Path $zip -DestinationPath $dest
          $graal = Get-ChildItem $dest | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $graal) { throw "GraalVM not found after unzip" }
          $env:GRAALVM_HOME = $graal.FullName
          $env:JAVA_HOME = $env:GRAALVM_HOME
          "GRAALVM_HOME=$env:GRAALVM_HOME" >> $env:GITHUB_ENV
          "JAVA_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
          "$env:GRAALVM_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Build release binary
        run: cargo build --release
      - name: Install WiX Toolset
        run: |
          $wixRoot = Get-ChildItem "C:/Program Files (x86)" -Filter "WiX Toolset v3.*" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $wixRoot) {
            choco install wixtoolset --version 3.14.0 -y --allow-downgrade
            $wixRoot = Get-ChildItem "C:/Program Files (x86)" -Filter "WiX Toolset v3.*" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }
          if (-not $wixRoot) { throw "WiX Toolset not found after install" }
          "WIX=$($wixRoot.FullName)\bin" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Install cargo-wix
        run: cargo install --git https://github.com/volks73/cargo-wix cargo-wix --force
      - name: Prepare wix manifest without workspace inheritance
        run: |
          cd ultrasearch/crates/ui
          (Get-Content Cargo.toml) -replace 'workspace\s*=\s*true', 'version = "*"' | Set-Content Cargo.wix.toml
      - name: Build unsigned MSI (ui crate)
        id: build_msi
        continue-on-error: true
        run: |
          cd ultrasearch/crates/ui
          $binPath = Resolve-Path ..\..\target\release\ui.exe
          cargo wix --manifest-path Cargo.wix.toml --bin-path "$binPath"
      - name: List wix outputs
        run: |
          Write-Host "Wix output contents:"
          Get-ChildItem ultrasearch/crates/ui/target/wix -Recurse -ErrorAction SilentlyContinue
      - name: Set MSI built output
        id: set_msi_output
        run: |
          $msiPath = Get-ChildItem ultrasearch/crates/ui/target/wix -Filter *.msi -Recurse -ErrorAction SilentlyContinue
          if ($msiPath) {
            Write-Host "MSI found: $($msiPath.FullName)"
            "msi_built=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "No MSI found under ultrasearch/crates/ui/target/wix"
            "msi_built=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
      - name: Upload MSI artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ultrasearch-msi
          path: ultrasearch/crates/ui/target/wix/**/*.msi
      - name: Upload release binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ultrasearch-release-bin
          path: target/release/ui.exe

  windows-e2e-smoke:
    name: Windows / E2E smoke (service + CLI)
    runs-on: windows-latest
    needs: [windows-tests]
    timeout-minutes: 60
    env:
      CARGO_TARGET_DIR: target
      CARGO_INCREMENTAL: 0
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - name: Install GraalVM CE 23 (zip) and set JAVA_HOME/GRAALVM_HOME
        run: |
          $ErrorActionPreference = "Stop"
          $uri = "https://download.oracle.com/graalvm/23/latest/graalvm-jdk-23_windows-x64_bin.zip"
          $zip = "$env:TEMP\graalvm.zip"
          Invoke-WebRequest -Uri $uri -OutFile $zip
          $dest = "C:\Program Files\GraalVM"
          if (-Not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }
          Expand-Archive -Force -Path $zip -DestinationPath $dest
          $graal = Get-ChildItem $dest | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $graal) { throw "GraalVM not found after unzip" }
          $env:GRAALVM_HOME = $graal.FullName
          $env:JAVA_HOME = $env:GRAALVM_HOME
          "GRAALVM_HOME=$env:GRAALVM_HOME" >> $env:GITHUB_ENV
          "JAVA_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
          "$env:GRAALVM_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy,rustfmt
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Build release
        run: cargo build --release
      - name: CLI help smoke
        run: cargo run -p cli --release -- --help
      - name: Service build presence
        run: Test-Path target/release/service.exe | Out-Null
      - name: UI build presence
        run: Test-Path target/release/ui.exe | Out-Null

  release-publish:
    name: Publish release artifacts
    runs-on: ubuntu-latest
    needs: [windows-msi]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Download MSI
        if: needs.windows-msi.outputs.msi_built == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ultrasearch-msi
          path: dist
      - name: Download release binary
        uses: actions/download-artifact@v4
        with:
          name: ultrasearch-release-bin
          path: dist
      - name: Publish GitHub Release assets
        if: needs.windows-msi.outputs.msi_built == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ui.exe
            dist/*.msi
      - name: Publish GitHub Release assets (no MSI)
        if: needs.windows-msi.outputs.msi_built != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/ui.exe
